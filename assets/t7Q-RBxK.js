import{d as E,a as _,u as j}from"#entry";import"./DOa35t5X.js";import{u as v}from"./BNgioekW.js";import{d as K}from"./BXsWsSdj.js";import"./CGs5VtEq.js";const U=E("chatHistory",{state:()=>({sessions:[],currentSessionId:null}),getters:{currentSession:e=>e.currentSessionId&&e.sessions.find(t=>t.id===e.currentSessionId)||null,allSessions:e=>e.sessions,sessionCount:e=>e.sessions.length},actions:{createSession(e,t,s,c,i,m){const a=Math.random().toString(36).substr(2,9),d=this.generateSessionName(e),f={id:a,name:d,createdAt:new Date,updatedAt:new Date,messages:[],selectedGPT:t,initialPrompt:e,model:s,temperature:c,maxTokens:i,topP:m};return this.sessions.push(f),this.currentSessionId=a,a},generateSessionName(e){const t=e.trim().slice(0,40);return t.length>0?t:"New Chat"},switchSession(e){if(!this.sessions.find(s=>s.id===e)){console.warn(`Session ${e} not found`);return}this.currentSessionId=e},updateSessionMessages(e){if(!this.currentSessionId)return;const t=this.sessions.find(s=>s.id===this.currentSessionId);t&&(t.messages=e,t.updatedAt=new Date)},updateSessionGPT(e){if(!this.currentSessionId)return;const t=this.sessions.find(s=>s.id===this.currentSessionId);t&&(t.selectedGPT=e,t.updatedAt=new Date)},updateSessionSettings(e,t,s,c){if(!this.currentSessionId)return;const i=this.sessions.find(m=>m.id===this.currentSessionId);i&&(i.model=e,i.temperature=t,i.maxTokens=s,i.topP=c,i.updatedAt=new Date)},updateSessionName(e,t){const s=this.sessions.find(c=>c.id===e);s&&(s.name=t,s.updatedAt=new Date)},renameSession(e,t){this.updateSessionName(e,t)},deleteSession(e){const t=this.sessions.findIndex(s=>s.id===e);t!==-1&&(this.sessions.splice(t,1),this.currentSessionId===e&&(this.sessions.length>0?this.currentSessionId=this.sessions[0].id:this.currentSessionId=null))},deleteAllSessions(){this.sessions=[],this.currentSessionId=null},clearSessionMessages(e){const t=this.sessions.find(s=>s.id===e);t&&(t.messages=[],t.updatedAt=new Date)}},persist:!0}),b=new Map,C=new Map,I=K([]),z=20,H=3e4,J=900*1e3;function X(){const e=new Date;for(const[t,s]of b.entries())s.expiresAt<e&&b.delete(t)}function W(){const t=Date.now()-60*1e3;return I.value=I.value.filter(s=>s>t),I.value.length<z}function q(){I.value.push(Date.now())}function G(e,t){return e.substring(0,200).trim()}async function Y(e,t={}){const{timeout:s=H,bypassCache:c=!1}=t;if(C.has(e))return C.get(e);const i=(async()=>{const m=crypto.randomUUID();try{if(!c){X();const l=b.get(e);if(l&&l.expiresAt>new Date)return{id:m,url:e,fetchedAt:l.fetchedAt,contentType:l.contentType,content:l.content,summary:G(l.content,e),isLoading:!1}}if(!W())throw{code:"network",message:"Rate limit exceeded: 20 fetches per minute"};q();try{new URL(e)}catch{throw{code:"invalid_url",message:`Invalid URL format: ${e}`}}const a=new AbortController,d=setTimeout(()=>a.abort(),s),{$supabase:f}=_(),u=await fetch(`${f.functions.url}/fetch-url`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${f.supabaseKey}`,apikey:f.supabaseKey},body:JSON.stringify({url:e}),signal:a.signal});if(clearTimeout(d),!u.ok)throw u.status===400?{code:"invalid_url",message:`Invalid URL or format: ${e}`}:u.status===401||u.status===403?{code:"access_denied",message:`Access denied to ${new URL(e).hostname}`}:u.status===415?{code:"unsupported_content",message:`Unsupported content type from ${new URL(e).hostname}`}:{code:"network",message:`HTTP ${u.status}: Failed to fetch ${e}`};const h=await u.json(),{content:n,contentType:y}=h;if(!n)throw{code:"unknown",message:"Empty response from server"};const p=new Date;return b.set(e,{content:n,contentType:y,fetchedAt:p,expiresAt:new Date(p.getTime()+J)}),{id:m,url:e,fetchedAt:p,contentType:y,content:n,summary:G(n,e),isLoading:!1}}catch(a){let d;return a instanceof TypeError?a.name==="AbortError"?d={code:"timeout",message:`Timeout fetching ${new URL(e).hostname} (>${s/1e3}s)`}:d={code:"network",message:`Network error: ${a.message}`}:a&&typeof a=="object"&&"code"in a?d=a:d={code:"unknown",message:`Unknown error: ${String(a)}`},{id:m,url:e,fetchedAt:new Date,contentType:"",content:"",error:d.message,isLoading:!1}}finally{C.delete(e)}})();return C.set(e,i),i}async function Q(e,t={}){if(e.length===0)return[];const c=e.slice(0,5).map(i=>Y(i,t).catch(m=>({id:crypto.randomUUID(),url:i,fetchedAt:new Date,contentType:"",content:"",error:`Failed to fetch: ${String(m)}`,isLoading:!1})));return Promise.all(c)}const V={"openai/gpt-oss-120b":{name:"GPT OSS 120B",description:"Most capable open-source model",contextLength:32768,provider:"OpenAI"},"meta-llama/Llama-3.3-70B-Instruct":{name:"Llama 3.3 70B",description:"Latest Llama model",contextLength:128e3,provider:"Meta"},"meta-llama/Meta-Llama-3.1-405B-Instruct-FP8":{name:"Llama 3.1 405B",description:"Largest Llama model",contextLength:128e3,provider:"Meta"},"meta-llama/Meta-Llama-3.1-8B-Instruct":{name:"Llama 3.1 8B",description:"Efficient Llama model",contextLength:128e3,provider:"Meta"},"meta-llama/CodeLlama-13b-Instruct-hf":{name:"CodeLlama 13B",description:"Optimized for coding",contextLength:16384,provider:"Meta"},"mistralai/Mistral-Small-24B-Instruct":{name:"Mistral Small 24B",description:"Compact Mistral model",contextLength:32768,provider:"Mistral"},"mistralai/Mistral-Nemo-Instruct-2407":{name:"Mistral Nemo",description:"Fast and efficient",contextLength:128e3,provider:"Mistral"},"mistralai/Mixtral-8x7B-Instruct-v0.1":{name:"Mixtral 8x7B",description:"MoE architecture",contextLength:32768,provider:"Mistral"},"openGPT-X/Teuken-7B-instruct-commercial":{name:"Teuken 7B",description:"Commercial model",contextLength:8192,provider:"OpenGPT-X"}},Z=E("chat",{state:()=>({messages:[],currentModel:"openai/gpt-oss-120b",systemPrompt:"You are a helpful AI assistant supporting teams at HIKEathon 2025. Be concise, accurate, and friendly.",currentGPTKey:"hikeathon-coach",isGenerating:!1,currentStreamingMessage:null,totalTokens:0,contextTokens:0,temperature:.7,maxTokens:2048,topP:.9,abortController:null,availableModels:Object.entries(V).map(([e,t])=>({id:e,name:t.name||e,description:t.description||"",contextLength:t.contextLength||8192,provider:t.provider||"Unknown"})),currentSessionId:null}),getters:{currentModelInfo:e=>e.availableModels.find(t=>t.id===e.currentModel),contextUsagePercent:e=>{const t=e.availableModels.find(s=>s.id===e.currentModel);return t?Math.min(100,e.contextTokens/t.contextLength*100):0},conversationHistory:e=>e.messages.filter(t=>t.role!=="system")},actions:{async fetchURLAttachments(e){if(e.length===0)return[];try{return await Q(e)}catch(t){throw console.error("Error fetching URLs:",t),t}},async sendMessage(e,t,s,c){if(this.isGenerating)return;const m=v().currentGPT;m&&m.systemPrompt&&(this.systemPrompt=m.systemPrompt),this.appendTimeToSystemPrompt();const a=t?.map(n=>({id:n.id,name:n.name,type:"image",size:n.size,content:`data:${n.type};base64,${n.base64}`})),d=s?.map(n=>({id:n.id,name:new URL(n.url).hostname||n.url,type:"url",size:n.content.length,content:n.content,url:n.url,processedData:{contentType:n.contentType,fetchedAt:n.fetchedAt,summary:n.summary,error:n.error}})),f=[...a||[],...d||[],...c||[]].filter(n=>n),u={id:crypto.randomUUID(),role:"user",content:e,timestamp:new Date,attachments:f.length>0?f:void 0};this.messages.push(u),this.isGenerating=!0;const h={id:crypto.randomUUID(),role:"assistant",content:"",timestamp:new Date,model:this.currentModel,isStreaming:!0};console.log("Created assistant message:",h.id,"Content:",h.content),this.messages.push(h),this.currentStreamingMessage=h,console.log("Messages array now has:",this.messages.length,"messages");try{const n=[{role:"system",content:this.systemPrompt},...this.messages.slice(-21,-1).map(r=>{const T={role:r.role};if(r.attachments&&r.attachments.length>0){const x=r.attachments.filter(o=>o.type==="image"),w=r.attachments.filter(o=>o.type==="url"),M=r.attachments.filter(o=>o.type==="text"),g=r.attachments.filter(o=>o.type==="pdf"),S=r.attachments.filter(o=>o.type==="docx"),P=w.map(o=>`[Web Content from ${o.name}]:
${o.content}`).join(`

`),$=M.map(o=>`[File Content from ${o.name}]:
${o.content}`).join(`

`),N=g.map(o=>`[PDF Content from ${o.name}]:
${o.content}`).join(`

`),O=S.map(o=>`[Document Content from ${o.name}]:
${o.content}`).join(`

`),k=[P,$,N,O].filter(o=>o).join(`

`);if(x.length>0){const o=r.content||"",R=k?`${o}

${k}`:o;T.content=[{type:"text",text:R},...x.map(F=>({type:"image_url",image_url:{url:F.content,detail:"auto"}}))]}else if(w.length>0||M.length>0||g.length>0||S.length>0){const o=k?`${r.content}

${k}`:r.content;T.content=o}else T.content=r.content}else T.content=r.content;return T})];if(this.abortController=new AbortController,!j().isAuthenticated)throw new Error("Not authenticated. Please login first.");const{$supabase:p}=_(),l=await fetch(`${p.functions.url}/proxy-chat`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${p.supabaseKey}`,apikey:p.supabaseKey},body:JSON.stringify({model:this.currentModel,messages:n,temperature:this.temperature,max_tokens:this.maxTokens,top_p:this.topP,stream:!0}),signal:this.abortController.signal});if(!l.ok){const r=await l.text();throw console.error("API error response:",r),new Error(`API error: ${l.statusText}`)}const D=l.body?.getReader();if(!D)throw new Error("No response body");const B=new TextDecoder;let A="";for(;;){const{done:r,value:T}=await D.read();if(r)break;A+=B.decode(T,{stream:!0});const x=A.split(`
`);A=x.pop()||"";for(const w of x)if(w.trim()!==""&&w.startsWith("data: ")){const M=w.slice(6).trim();if(M==="[DONE]"){const g=this.messages.findIndex(S=>S.id===h.id);g!==-1&&(console.log("Stream completed, final content:",this.messages[g].content),this.messages[g].isStreaming=!1),this.currentStreamingMessage=null;break}try{const S=JSON.parse(M).choices?.[0]?.delta?.content;if(S){const P=this.messages.findIndex($=>$.id===h.id);P!==-1&&(this.messages[P].content+=S,console.log("Added content chunk:",S,"Total length:",this.messages[P].content.length))}}catch(g){console.warn("Failed to parse SSE line:",w,g)}}}const L=this.messages.findIndex(r=>r.id===h.id);L!==-1&&(this.messages[L].tokens=this.estimateTokens(this.messages[L].content)),this.updateTokenCounts()}catch(n){if(n.name!=="AbortError"){console.error("Chat error:",n);const y=this.messages.findIndex(p=>p.id===h.id);y!==-1&&(this.messages[y].error=n.message,this.messages[y].content="Sorry, an error occurred while generating the response.",this.messages[y].isStreaming=!1)}this.currentStreamingMessage=null}finally{this.isGenerating=!1,this.abortController=null}},stopGeneration(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.currentStreamingMessage&&(this.currentStreamingMessage.isStreaming=!1,this.currentStreamingMessage=null),this.isGenerating=!1},clearMessages(){this.messages=[],this.totalTokens=0,this.contextTokens=0},deleteMessage(e){const t=this.messages.findIndex(s=>s.id===e);t!==-1&&(this.messages.splice(t,1),this.updateTokenCounts())},setModel(e){this.currentModel=e},setSystemPrompt(e){this.systemPrompt=e},setTemperature(e){this.temperature=Math.max(0,Math.min(2,e))},setMaxTokens(e){this.maxTokens=Math.max(1,Math.min(4096,e))},estimateTokens(e){return e?Math.ceil(e.length/4):0},updateTokenCounts(){let e=0,t=this.estimateTokens(this.systemPrompt);for(const s of this.messages){const c=s.tokens||this.estimateTokens(s.content);e+=c,this.messages.indexOf(s)>=this.messages.length-20&&(t+=c)}this.totalTokens=e,this.contextTokens=t},setCurrentSessionId(e){this.currentSessionId=e},setCurrentGPTKey(e){this.currentGPTKey=e},appendTimeToSystemPrompt(){if(this.currentGPTKey!=="hikeathon-coach")return;const e=/\n\n\*\*Current date and time:\*\*.+$/;this.systemPrompt=this.systemPrompt.replace(e,"");const t=new Date().toLocaleString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0});this.systemPrompt+=`

**Current date and time:** ${t}`},initializeSystemPrompt(){const t=v().allGPTs[this.currentGPTKey];t&&t.systemPrompt&&(this.systemPrompt=t.systemPrompt),this.appendTimeToSystemPrompt()},saveCurrentSession(){if(!this.currentSessionId)return;const e=U();e.updateSessionMessages(this.messages),e.updateSessionSettings(this.currentModel,this.temperature,this.maxTokens,this.topP)},async loadSession(e){const t=U(),s=t.sessions.find(i=>i.id===e);if(!s)return;this.currentSessionId=e,t.currentSessionId=e,this.messages=[...s.messages],this.currentModel=s.model,this.temperature=s.temperature,this.maxTokens=s.maxTokens,this.topP=s.topP,await v().selectSystemPrompt(s.selectedGPT),this.currentGPTKey=s.selectedGPT,this.updateTokenCounts()}},persist:{paths:["currentModel","currentGPTKey","temperature","maxTokens","topP","currentSessionId"]}}),re=Object.freeze(Object.defineProperty({__proto__:null,useChatStore:Z},Symbol.toStringTag,{value:"Module"}));export{Z as a,re as c,Q as f,U as u};
