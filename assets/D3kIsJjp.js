import{a as n}from"#entry";import"./BXsWsSdj.js";import"./CdQP9W9V.js";class c{supabase;constructor(e){this.supabase=e}async createNotification(e){const{data:t,error:a}=await this.supabase.from("notifications").insert({message:e.message,type:e.type,sender:e.sender||"System",metadata:e.metadata||{}}).select().single();if(a)throw new Error(`Failed to create notification: ${a.message}`);return t}async getNotifications(e=25,t=0){const{data:a,error:i}=await this.supabase.from("notifications").select("*").order("created_at",{ascending:!1}).range(t,t+e-1);if(i)throw new Error(`Failed to fetch notifications: ${i.message}`);return a||[]}async getNotificationsForTeam(e,t=25,a=0){const{data:i,error:o}=await this.supabase.rpc("get_notifications_for_team",{p_team_code:e,p_limit:t,p_offset:a});if(o)throw new Error(`Failed to fetch notifications for team: ${o.message}`);return i||[]}async markAsRead(e,t){const{error:a}=await this.supabase.from("notification_reads").upsert({notification_id:e,team_code:t},{onConflict:"notification_id,team_code"});if(a)throw new Error(`Failed to mark notification as read: ${a.message}`)}async markAllAsRead(e){const{data:t,error:a}=await this.supabase.from("notifications").select("id");if(a)throw new Error(`Failed to fetch notifications: ${a.message}`);if(!t||t.length===0)return;const i=t.map(s=>({notification_id:s.id,team_code:e})),{error:o}=await this.supabase.from("notification_reads").upsert(i,{onConflict:"notification_id,team_code"});if(o)throw new Error(`Failed to mark all as read: ${o.message}`)}async getUnreadCount(e){const{data:t,error:a}=await this.supabase.rpc("get_unread_notification_count",{p_team_code:e});if(a)throw new Error(`Failed to get unread count: ${a.message}`);return t||0}async sendNotification(e){const t=await this.createNotification(e);return await this.supabase.channel("broadcasts").send({type:"broadcast",event:"message",payload:{id:t.id,message:t.message,type:t.type,timestamp:t.created_at,from:t.sender}}),t}async deleteOldNotifications(e=30){const t=new Date;t.setDate(t.getDate()-e);const{data:a,error:i}=await this.supabase.from("notifications").delete().lt("created_at",t.toISOString()).select();return i?(console.error("Failed to delete old notifications:",i),0):a?.length||0}}const l=()=>{const{$supabase:r}=n();return new c(r)};export{c as NotificationService,l as useNotificationService};
