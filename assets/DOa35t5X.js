import{v as w,u as y}from"#entry";class m{baseURL;requestQueue=[];isRefreshing=!1;constructor(t){const e=w();this.baseURL=t||e.public.supabaseUrl}async prepareHeaders(t={}){const e=new Headers(t.headers||{});if(!t.skipAuth){const r=await y().getToken();r&&e.set("Authorization",`Bearer ${r}`)}return e.has("Content-Type")||e.set("Content-Type","application/json"),e}async request(t,e={}){if(this.isRefreshing&&!e.skipAuth)return new Promise((a,n)=>{this.requestQueue.push({resolve:a,reject:n,url:t,options:e})});const s=t.startsWith("http")?t:`${this.baseURL}${t}`,r=await this.prepareHeaders(e),i={...e,headers:r};try{const a=await fetch(s,i);return a.status===401&&!e.skipAuth?this.handle401(t,e):a.status===429?this.handleRateLimit(a,t,e):a}catch(a){if(e.retries&&e.retries>0){const n=e.retryDelay||1e3;return await new Promise(u=>setTimeout(u,n)),this.request(t,{...e,retries:e.retries-1,retryDelay:n*2})}throw a}}async handle401(t,e){const s=y();if(!this.isRefreshing){this.isRefreshing=!0;try{return await s.refreshSession(),this.processQueue(null),this.request(t,e)}catch(r){throw this.processQueue(r),s.logout(),r}finally{this.isRefreshing=!1}}return new Promise((r,i)=>{this.requestQueue.push({resolve:r,reject:i,url:t,options:e})})}async handleRateLimit(t,e,s){const r=t.headers.get("Retry-After"),i=r?parseInt(r)*1e3:5e3;return console.warn(`Rate limited. Retrying after ${i}ms`),await new Promise(a=>setTimeout(a,i)),this.request(e,s)}processQueue(t){this.requestQueue.forEach(({resolve:e,reject:s,url:r,options:i})=>{t?s(t):this.request(r,i).then(e).catch(s)}),this.requestQueue=[]}async get(t,e){return this.request(t,{...e,method:"GET"})}async post(t,e,s){return this.request(t,{...s,method:"POST",body:e?JSON.stringify(e):void 0})}async put(t,e,s){return this.request(t,{...s,method:"PUT",body:e?JSON.stringify(e):void 0})}async delete(t,e){return this.request(t,{...e,method:"DELETE"})}async stream(t,e,s){const r=t.startsWith("http")?t:`${this.baseURL}${t}`,i=await this.prepareHeaders(s);i.set("Accept","text/event-stream");const a=await fetch(r,{...s,headers:i});if(!a.ok||!a.body)throw new Error(`Stream request failed: ${a.statusText}`);const n=a.body.getReader(),u=new TextDecoder;let o="";return(async()=>{try{for(;;){const{done:h,value:p}=await n.read();if(h)break;o+=u.decode(p,{stream:!0});const d=o.split(`
`);o=d.pop()||"";for(const f of d)if(f.startsWith("data: ")){const l=f.slice(6);if(l==="[DONE]")return;try{const c=JSON.parse(l);e(c)}catch(c){console.error("Failed to parse SSE data:",c)}}}}catch(h){throw console.error("Stream reading error:",h),h}})(),()=>{n.cancel()}}}new m;
