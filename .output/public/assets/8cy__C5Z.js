const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./DyB7GgJ-.js","./K9wtrZOj.js","./lyzmDKnL.js","./wtOtceyD.js","./entry.eNJDJpza.css"])))=>i.map(i=>d[i]);
import{_ as k}from"./wtOtceyD.js";import{u as z,a as $}from"#entry";import{u as j,s as F}from"./BQPXNKIG.js";import{b as r,a1 as H,a7 as P,a8 as h}from"./lyzmDKnL.js";const Q=()=>{const{$supabase:_}=z(),v=_,n=$(),s=r(!0),c=r(new Map),u=r([]),m=r(new Map),w=r(new Map),i=r("disconnected"),l=r(0),y=3,A=2e3,d=r(!1);let b=null,f=null;const B=async()=>{if(!s.value){console.warn("Supabase not available, skipping broadcasts subscription");return}try{console.log("ðŸ”§ Creating broadcast channel...");const t=v.channel("broadcasts",{config:{broadcast:{self:!0}}}).on("broadcast",{event:"message"},e=>{console.log("ðŸ“¡ Broadcast received:",e);const a={id:e.payload.id||crypto.randomUUID(),message:e.payload.message,type:e.payload.type||"info",timestamp:e.payload.timestamp||new Date().toISOString(),from:e.payload.from};u.value.unshift(a),console.log("ðŸ“¡ Broadcast added to list. Total broadcasts:",u.value.length),u.value.length>50&&(u.value=u.value.slice(0,50))}).subscribe(e=>{console.log("ðŸ“¡ Broadcast channel status:",e),e==="SUBSCRIBED"?(console.log("âœ… Subscribed to broadcasts channel"),i.value="connected",l.value=0,d.value=!1):e==="CHANNEL_ERROR"||e==="TIMED_OUT"?(console.error("âŒ Error subscribing to broadcasts:",e),d.value||(l.value>=y?(s.value=!1,console.warn("Max reconnect attempts reached, disabling realtime features")):T())):e==="CLOSED"&&!d.value&&s.value&&(console.warn("Channel closed unexpectedly"),l.value<y&&T())});c.value.set("broadcasts",t),console.log("ðŸ”§ Broadcast channel configured")}catch(t){console.error("Failed to subscribe to broadcasts:",t),s.value=!1}},U=async()=>{if(!n.currentTeam)return;const t=v.channel("presence").on("presence",{event:"sync"},()=>{const e=t.presenceState();m.value.clear(),Object.entries(e).forEach(([a,o])=>{if(o&&o.length>0){const g=o[0];m.value.set(a,g)}})}).on("presence",{event:"join"},({key:e,newPresences:a})=>{if(a&&a.length>0){const o=a[0];m.value.set(e||"",o)}}).on("presence",{event:"leave"},({key:e})=>{m.value.delete(e||"")}).subscribe(async e=>{e==="SUBSCRIBED"&&await t.track({teamId:n.currentTeam.id,teamName:n.currentTeam.name,onlineAt:new Date().toISOString(),status:"active"})});c.value.set("presence",t)},C=async()=>{const t=v.channel("typing").on("broadcast",{event:"typing"},e=>{const a=e.payload;a.teamId!==n.currentTeam?.id&&(a.isTyping?(w.value.set(a.teamId,a),setTimeout(()=>{w.value.delete(a.teamId)},3e3)):w.value.delete(a.teamId))}).subscribe();c.value.set("typing",t)},D=async()=>{const t=v.channel("todos").on("postgres_changes",{event:"*",schema:"public",table:"todos"},e=>{console.log("Todo update:",e)}).on("postgres_changes",{event:"*",schema:"public",table:"team_todos"},e=>{console.log("Team todo update:",e)}).subscribe();c.value.set("todos",t)},N=async()=>{const t=j(),e=v.channel("countdowns").on("postgres_changes",{event:"*",schema:"public",table:"countdowns"},async a=>{console.log("Countdown update:",a),await t.fetchActiveCountdown()}).subscribe();c.value.set("countdowns",e)},R=async(t,e="info",a)=>{const o=c.value.get("broadcasts");if(!o)throw console.error("âŒ Broadcasts channel not initialized"),new Error("Broadcasts channel not initialized");const g=a||n.currentTeam?.name||"anonymous";try{const{useNotificationService:I}=await k(async()=>{const{useNotificationService:x}=await import("./DyB7GgJ-.js");return{useNotificationService:x}},__vite__mapDeps([0,1,2,3,4]),import.meta.url);await I().createNotification({message:t,type:e,sender:g,metadata:{}}),console.log("âœ… Notification persisted to database")}catch(I){console.error("Failed to persist notification:",I)}const E={id:crypto.randomUUID(),message:t,type:e,timestamp:new Date().toISOString(),from:g};console.log("ðŸ“¤ Sending broadcast:",E),console.log("ðŸ“¤ Channel state:",o.state);const L=await o.send({type:"broadcast",event:"message",payload:E});console.log("ðŸ“¤ Broadcast send result:",L)},O=async t=>{if(!n.currentTeam)return;const e=c.value.get("typing");e&&await e.send({type:"broadcast",event:"typing",payload:{teamId:n.currentTeam.id,teamName:n.currentTeam.name,isTyping:t}})},M=()=>{b&&clearInterval(b),b=F(async()=>{if(i.value==="connected"&&n.currentTeam){const t=c.value.get("presence");t&&await t.track({teamId:n.currentTeam.id,teamName:n.currentTeam.name,onlineAt:new Date().toISOString(),status:"active"})}},3e4)},T=()=>{if(!(!s.value||d.value)){if(l.value>=y){console.error("Max reconnection attempts reached, disabling realtime"),i.value="disconnected",s.value=!1,d.value=!1;return}f&&clearTimeout(f),d.value=!0,f=setTimeout(async()=>{l.value++,console.log(`Reconnection attempt ${l.value}/${y}`),i.value="connecting",await p(!0),await S()},A*Math.pow(2,l.value))}},p=async(t=!1)=>{const e=s.value;t||(s.value=!1);for(const[a,o]of c.value)try{await o.unsubscribe(),t||console.log(`Unsubscribed from ${a} channel`)}catch{}c.value.clear(),t||(s.value=e)},S=async()=>{try{i.value="connecting",await B(),await N(),n.isAuthenticated&&(await U(),await C(),await D()),M(),window.addEventListener("beforeunload",p),window.addEventListener("online",()=>{console.log("Network connection restored"),T()}),window.addEventListener("offline",()=>{console.log("Network connection lost"),i.value="disconnected"})}catch(t){console.error("Error initializing realtime:",t),T()}};return H(()=>{S()}),P(()=>{b&&clearInterval(b),f&&clearTimeout(f),p(),window.removeEventListener("beforeunload",p)}),{broadcasts:h(u),presence:h(m),typingUsers:h(w),connectionState:h(i),isSupabaseAvailable:h(s),sendBroadcast:R,sendTypingIndicator:O,initializeRealtime:S,cleanupChannels:p}};export{Q as u};
