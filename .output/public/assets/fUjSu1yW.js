import{d,f as m,g as r,n as a,i as u}from"#entry";import"./lyzmDKnL.js";import"./wtOtceyD.js";const c=[{id:"admin-1",email:"admin@hikeathon.com",name:"HIKEathon Admin",role:"super_admin",permissions:["*"],passwordHash:"$2a$10$rQ0yKm5xGf.Kd6PvJLmhIOkGzLzYXqGmHf3vL4VwZWx8hX2VlBGJm",mfaEnabled:!0,mfaSecret:"JBSWY3DPEHPK3PXP"}],h=d("admin",{state:()=>({currentAdmin:null,session:null,isAuthenticated:!1,isLoading:!1,error:null,auditLogs:[],mfaPending:!1}),getters:{hasPermission:i=>e=>i.currentAdmin?i.currentAdmin.permissions.includes("*")?!0:i.currentAdmin.permissions.includes(e):!1,isSessionValid:i=>i.session?Date.now()<i.session.expiresAt&&i.session.mfaVerified:!1,sessionTimeRemaining:i=>i.session?Math.max(0,i.session.expiresAt-Date.now()):0},actions:{async login(i,e){this.isLoading=!0,this.error=null;try{const n=c.find(s=>s.email===i);if(!n)throw new Error("Invalid credentials");if(e!=="admin123")throw new Error("Invalid credentials");return this.currentAdmin={id:n.id,email:n.email,name:n.name,role:n.role,permissions:n.permissions,mfaEnabled:n.mfaEnabled},await this.logAction("admin_login_attempt","auth",{email:i,success:!0}),n.mfaEnabled?(this.mfaPending=!0,this.mfaSecret=n.mfaSecret,{requiresMFA:!0}):(await this.completeLogin(),{requiresMFA:!1})}catch(n){throw this.error=n.message,await this.logAction("admin_login_attempt","auth",{email:i,success:!1,error:n.message}),n}finally{this.isLoading=!1}},async verifyMFA(i){if(!this.mfaPending||!this.currentAdmin)throw new Error("MFA verification not required");try{if(!(i==="123456"||i==="000000"))throw new Error("Invalid MFA code");return await this.completeLogin(),this.mfaPending=!1,this.mfaSecret=void 0,await this.logAction("admin_mfa_verified","auth",{adminId:this.currentAdmin.id}),!0}catch(e){throw this.error=e.message,await this.logAction("admin_mfa_failed","auth",{adminId:this.currentAdmin?.id,error:e.message}),e}},async completeLogin(){if(!this.currentAdmin)return;const i=this.generateSessionToken(),e=Date.now()+7200*1e3;this.session={token:i,expiresAt:e,mfaVerified:!0},this.isAuthenticated=!0,this.currentAdmin.lastLogin=new Date().toISOString(),typeof window<"u"&&sessionStorage.setItem("admin_session",JSON.stringify({admin:this.currentAdmin,session:this.session})),await this.logAction("admin_login_success","auth",{adminId:this.currentAdmin.id,sessionDuration:"2h"})},async logout(){const i=this.currentAdmin?.id;typeof window<"u"&&sessionStorage.removeItem("admin_session"),this.currentAdmin=null,this.session=null,this.isAuthenticated=!1,this.mfaPending=!1,this.error=null,i&&await this.logAction("admin_logout","auth",{adminId:i})},async restoreSession(){try{if(typeof window>"u")return!1;const i=sessionStorage.getItem("admin_session");if(!i)return!1;const e=JSON.parse(i),{admin:n,session:s}=e;return Date.now()>=s.expiresAt?(sessionStorage.removeItem("admin_session"),!1):(this.currentAdmin=n,this.session=s,this.isAuthenticated=!0,!0)}catch(i){return console.error("Failed to restore admin session:",i),!1}},generateSessionToken(){return`admin_${Date.now()}_${Math.random().toString(36).substr(2,9)}`},async logAction(i,e,n={}){const s={id:crypto.randomUUID(),adminId:this.currentAdmin?.id||"unknown",adminEmail:this.currentAdmin?.email||"unknown",action:i,resource:e,details:n,timestamp:new Date().toISOString(),ipAddress:"localhost",userAgent:typeof navigator<"u"?navigator.userAgent:"unknown"};this.auditLogs.unshift(s),this.auditLogs.length>1e3&&(this.auditLogs=this.auditLogs.slice(0,1e3)),console.log("Admin Action:",s)},getAuditLogs(i={}){let e=[...this.auditLogs];if(i.adminId&&(e=e.filter(n=>n.adminId===i.adminId)),i.action&&(e=e.filter(n=>n.action.includes(i.action))),i.resource&&(e=e.filter(n=>n.resource===i.resource)),i.from){const n=new Date(i.from);e=e.filter(s=>new Date(s.timestamp)>=n)}if(i.to){const n=new Date(i.to);e=e.filter(s=>new Date(s.timestamp)<=n)}return e.slice(0,i.limit||100)},checkPermission(i){return this.hasPermission(i)},requirePermission(i){if(!this.isAuthenticated)throw new Error("Not authenticated");if(!this.hasPermission(i))throw new Error(`Permission denied: ${i}`)}},persist:!1}),w=m(async i=>{let e,n;const s=h();if(i.path==="/admin/login")return;const o=([e,n]=r(()=>s.restoreSession()),e=await e,n(),e);if(!s.isAuthenticated&&!o)return a("/admin/login");if(!s.isSessionValid)return[e,n]=r(()=>s.logout()),await e,n(),a("/admin/login");const t={"/admin/dashboard":"admin.dashboard.view","/admin/telemetry":"admin.telemetry.view","/admin/broadcast":"admin.broadcast.manage","/admin/todos":"admin.todos.manage","/admin/system":"admin.system.monitor"}[i.path];if(t&&!s.hasPermission(t))throw[e,n]=r(()=>s.logAction("unauthorized_access","admin_route",{path:i.path,requiredPermission:t})),await e,n(),u({statusCode:403,statusMessage:"Access Denied: Insufficient permissions"})});export{w as default};
